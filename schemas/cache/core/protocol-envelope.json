{
  "$id": "/schemas/2.4.0/core/protocol-envelope.json",
  "$schema": "http://json-schema.org/draft-07/schema#",
  "additionalProperties": false,
  "description": "Standard envelope structure for AdCP task responses. This envelope is added by the protocol layer (MCP, A2A, REST) and wraps the task-specific response payload. Task response schemas should NOT include these fields - they are protocol-level concerns.",
  "examples": [
    {
      "data": {
        "context_id": "ctx_abc123",
        "message": "Found 3 products matching your criteria for CTV inventory in California",
        "payload": {
          "products": [
            {
              "description": "Premium connected TV inventory across California",
              "name": "CTV Premium - California",
              "pricing": {
                "amount": 45.0,
                "currency": "USD",
                "model": "cpm"
              },
              "product_id": "ctv_premium_ca"
            }
          ]
        },
        "status": "completed",
        "timestamp": "2025-10-14T14:25:30Z"
      },
      "description": "Synchronous task response with immediate results"
    },
    {
      "data": {
        "context_id": "ctx_def456",
        "message": "Media buy creation submitted. Processing will take approximately 5-10 minutes. You'll receive updates via webhook.",
        "payload": {
          "buyer_ref": "campaign_2024_q1"
        },
        "push_notification_config": {
          "authentication": {
            "credentials": "shared_secret_exchanged_during_onboarding_min_32_chars",
            "schemes": [
              "HMAC-SHA256"
            ]
          },
          "url": "https://buyer.example.com/webhooks/adcp"
        },
        "status": "submitted",
        "task_id": "task_789",
        "timestamp": "2025-10-14T14:30:00Z"
      },
      "description": "Asynchronous task response with pending operation"
    },
    {
      "data": {
        "context_id": "ctx_ghi789",
        "message": "This media buy requires manual approval. Please review the terms and confirm to proceed.",
        "payload": {
          "buyer_ref": "campaign_2024_q1",
          "errors": [
            {
              "code": "APPROVAL_REQUIRED",
              "message": "Budget exceeds auto-approval threshold",
              "severity": "warning"
            }
          ],
          "media_buy_id": "mb_123456",
          "packages": [
            {
              "buyer_ref": "pkg_premium_ctv",
              "package_id": "pkg_001"
            }
          ]
        },
        "status": "input-required",
        "task_id": "task_101",
        "timestamp": "2025-10-14T14:32:15Z"
      },
      "description": "Task response requiring user input"
    },
    {
      "data": {
        "context_id": "ctx_jkl012",
        "message": "Unable to create media buy due to invalid targeting parameters",
        "payload": {
          "errors": [
            {
              "code": "INVALID_TARGETING",
              "field": "targeting.geo_codes",
              "message": "Geographic targeting codes are invalid",
              "severity": "error"
            }
          ]
        },
        "status": "failed",
        "timestamp": "2025-10-14T14:28:45Z"
      },
      "description": "Failed task response with error details"
    }
  ],
  "notes": [
    "Task response schemas (e.g., get-products-response.json) define ONLY the payload structure",
    "Protocol implementations (MCP, A2A, REST) wrap the payload with this envelope",
    "Different protocols may use different serialization formats but maintain the same semantic structure",
    "MCP may represent this via tool response content fields and metadata",
    "A2A may represent this via assistant messages with structured data",
    "REST may use HTTP headers for status/task metadata and JSON body for payload",
    "The envelope ensures consistent behavior across all protocol implementations"
  ],
  "properties": {
    "context_id": {
      "description": "Session/conversation identifier for tracking related operations across multiple task invocations. Managed by the protocol layer to maintain conversational context.",
      "type": "string"
    },
    "message": {
      "description": "Human-readable summary of the task result. Provides natural language explanation of what happened, suitable for display to end users or for AI agent comprehension. Generated by the protocol layer based on the task response.",
      "type": "string"
    },
    "payload": {
      "additionalProperties": true,
      "description": "The actual task-specific response data. This is the content defined in individual task response schemas (e.g., get-products-response.json, create-media-buy-response.json). Contains only domain-specific data without protocol-level fields.",
      "type": "object"
    },
    "push_notification_config": {
      "$ref": "push-notification-config.json",
      "description": "Push notification configuration for async task updates (A2A and REST protocols). Echoed from the request to confirm webhook settings. Specifies URL, authentication scheme (Bearer or HMAC-SHA256), and credentials. MCP uses progress notifications instead of webhooks."
    },
    "status": {
      "$ref": "../enums/task-status.json",
      "description": "Current task execution state. Indicates whether the task is completed, in progress (working), submitted for async processing, failed, or requires user input. Managed by the protocol layer."
    },
    "task_id": {
      "description": "Unique identifier for tracking asynchronous operations. Present when a task requires extended processing time. Used to query task status and retrieve results when complete.",
      "type": "string"
    },
    "timestamp": {
      "description": "ISO 8601 timestamp when the response was generated. Useful for debugging, logging, cache validation, and tracking async operation progress.",
      "format": "date-time",
      "type": "string"
    }
  },
  "required": [
    "status",
    "payload"
  ],
  "title": "Protocol Envelope",
  "type": "object"
}