#!/usr/bin/env python3
"""
Generate Pydantic models from AdCP task request/response schemas.

Simplified approach that handles the task schemas we need for type safety.
Core types are manually maintained in types/core.py.
"""

import json
import re
import subprocess
import sys
from pathlib import Path

SCHEMAS_DIR = Path(__file__).parent.parent / "schemas" / "cache" / "latest"
OUTPUT_DIR = Path(__file__).parent.parent / "src" / "adcp" / "types"


def snake_to_pascal(name: str) -> str:
    """Convert snake_case to PascalCase."""
    return "".join(word.capitalize() for word in name.split("-"))


def generate_model_for_schema(schema_file: Path) -> str:
    """Generate Pydantic model code for a single schema inline."""
    with open(schema_file) as f:
        schema = json.load(f)

    # Start with model name
    model_name = snake_to_pascal(schema_file.stem)
    lines = [f"class {model_name}(BaseModel):"]

    # Add description if available
    if "description" in schema:
        lines.append(f'    """{schema["description"]}"""')
        lines.append("")

    # Add properties
    if "properties" not in schema:
        lines.append("    pass")
        return "\n".join(lines)

    for prop_name, prop_schema in schema["properties"].items():
        # Get type
        prop_type = get_python_type(prop_schema)

        # Get description
        desc = prop_schema.get("description", "")

        # Check if required
        is_required = prop_name in schema.get("required", [])

        if is_required:
            if desc:
                lines.append(f'    {prop_name}: {prop_type} = Field(description="{desc}")')
            else:
                lines.append(f"    {prop_name}: {prop_type}")
        else:
            if desc:
                lines.append(f'    {prop_name}: {prop_type} | None = Field(None, description="{desc}")')
            else:
                lines.append(f"    {prop_name}: {prop_type} | None = None")

    return "\n".join(lines)


def get_python_type(schema: dict) -> str:
    """Convert JSON schema type to Python type hint."""
    if "$ref" in schema:
        # Reference to another model
        ref = schema["$ref"]
        return snake_to_pascal(ref.replace(".json", ""))

    schema_type = schema.get("type")

    if schema_type == "string":
        if "enum" in schema:
            # Literal type
            values = ", ".join(f'"{v}"' for v in schema["enum"])
            return f"Literal[{values}]"
        return "str"

    if schema_type == "number":
        return "float"

    if schema_type == "integer":
        return "int"

    if schema_type == "boolean":
        return "bool"

    if schema_type == "array":
        items = schema.get("items", {})
        item_type = get_python_type(items)
        return f"list[{item_type}]"

    if schema_type == "object":
        # Generic object
        return "dict[str, Any]"

    return "Any"


def main():
    """Generate models for all task request/response schemas."""
    if not SCHEMAS_DIR.exists():
        print("Error: Schemas not found. Run scripts/sync_schemas.py first.", file=sys.stderr)
        sys.exit(1)

    print(f"Generating task models from {SCHEMAS_DIR}...")

    # Find all task schemas (request/response)
    task_schemas = sorted(SCHEMAS_DIR.glob("*-request.json")) + sorted(SCHEMAS_DIR.glob("*-response.json"))

    print(f"Found {len(task_schemas)} task schemas\n")

    # Generate header
    output_lines = [
        '"""',
        "Auto-generated Pydantic models from AdCP JSON schemas.",
        "",
        "DO NOT EDIT THIS FILE MANUALLY.",
        "Generated from: https://adcontextprotocol.org/schemas/v1/",
        "To regenerate:",
        "  python scripts/sync_schemas.py",
        "  python scripts/fix_schema_refs.py",
        "  python scripts/generate_models_simple.py",
        '"""',
        "",
        "from __future__ import annotations",
        "",
        "from typing import Any, Literal",
        "",
        "from pydantic import BaseModel, Field",
        "",
        "# Import core types from adcp.types.core",
        "# (Product, MediaBuy, CreativeAsset, etc.)",
        "",
        "",
    ]

    # Generate each model
    for schema_file in task_schemas:
        print(f"  Generating {schema_file.stem}...")
        try:
            model_code = generate_model_for_schema(schema_file)
            output_lines.append(model_code)
            output_lines.append("")
            output_lines.append("")
        except Exception as e:
            print(f"    Warning: Could not generate model: {e}")

    # Write output
    output_file = OUTPUT_DIR / "tasks.py"
    output_file.write_text("\n".join(output_lines))

    print(f"\nâœ“ Successfully generated task models")
    print(f"  Output: {output_file}")
    print(f"  Models: {len(task_schemas)}")


if __name__ == "__main__":
    main()
