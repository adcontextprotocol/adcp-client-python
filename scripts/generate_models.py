#!/usr/bin/env python3
"""
Generate Pydantic models from AdCP JSON schemas.

This script uses datamodel-code-generator to create type-safe Python models
from the official AdCP schemas, ensuring our types never drift from the spec.
"""

import subprocess
import sys
from pathlib import Path

SCHEMAS_DIR = Path(__file__).parent.parent / "schemas" / "cache" / "latest"
OUTPUT_FILE = Path(__file__).parent.parent / "src" / "adcp" / "types" / "generated.py"


def main():
    """Generate Pydantic models from JSON schemas."""
    if not SCHEMAS_DIR.exists():
        print("Error: Schemas not found. Run scripts/sync_schemas.py first.", file=sys.stderr)
        sys.exit(1)

    print(f"Generating Pydantic models from {SCHEMAS_DIR}...")
    print(f"Output: {OUTPUT_FILE}\n")

    # Get all schema files
    schema_files = sorted(SCHEMAS_DIR.glob("*.json"))
    print(f"Found {len(schema_files)} schemas\n")

    # Generate models using datamodel-code-generator
    cmd = [
        "datamodel-codegen",
        "--input", str(SCHEMAS_DIR),
        "--input-file-type", "jsonschema",
        "--output", str(OUTPUT_FILE),
        "--output-model-type", "pydantic_v2.BaseModel",
        "--use-standard-collections",
        "--use-schema-description",
        "--use-field-description",
        "--field-constraints",
        "--use-default",
        "--enum-field-as-literal", "all",
        "--target-python-version", "3.10",
        "--collapse-root-models",
        "--allow-extra-fields",
        "--enable-version-header",
    ]

    print("Running datamodel-codegen...")
    result = subprocess.run(cmd, capture_output=True, text=True)

    if result.returncode != 0:
        print("Error generating models:", file=sys.stderr)
        print(result.stderr, file=sys.stderr)
        sys.exit(1)

    # Add header comment
    header = '''"""
Auto-generated Pydantic models from AdCP JSON schemas.

DO NOT EDIT THIS FILE MANUALLY.
Generated from: https://adcontextprotocol.org/schemas/v1/
To regenerate: python scripts/sync_schemas.py && python scripts/generate_models.py
"""

from __future__ import annotations

'''

    # Read generated content
    content = OUTPUT_FILE.read_text()

    # Prepend header
    OUTPUT_FILE.write_text(header + content)

    print(f"\nâœ“ Successfully generated models")
    print(f"  Output: {OUTPUT_FILE}")
    print(f"  Lines: {len(content.splitlines())}")


if __name__ == "__main__":
    main()
