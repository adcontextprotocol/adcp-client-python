name: CI

on:
  push:
    branches: [main, python-adcp-sdk-setup]
  pull_request:
    branches: [main]

jobs:
  test:
    name: Test Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12", "3.13"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run linter
        run: |
          ruff check src/

      - name: Run type checker
        run: |
          mypy src/adcp/

      - name: Run tests
        run: |
          pytest tests/ -v --cov=src/adcp --cov-report=term-missing

  conventional-commits:
    name: Validate conventional commit format
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate PR commits
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate individual commits
        run: |
          # Get the base branch
          BASE_SHA=$(git merge-base origin/${{ github.base_ref }} HEAD)

          # Check each commit since the base
          echo "Validating commits since $BASE_SHA..."
          git log --format="%H %s" $BASE_SHA..HEAD | while read sha message; do
            # Skip merge commits (GitHub automatically creates these)
            if echo "$message" | grep -qE '^Merge [0-9a-f]+ into [0-9a-f]+'; then
              echo "⊙ Skipping merge commit: $sha"
              continue
            fi

            # Check if message matches conventional commit format
            if ! echo "$message" | grep -qE '^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\([^)]+\))?!?: .+'; then
              echo "❌ Commit $sha does not follow Conventional Commits format:"
              echo "   $message"
              echo ""
              echo "Expected format: <type>[optional scope]: <description>"
              echo "Types: feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert"
              echo ""
              echo "Examples:"
              echo "  feat: add new feature"
              echo "  fix: resolve bug in parser"
              echo "  feat(api): add new endpoint"
              echo "  feat!: breaking change"
              exit 1
            else
              echo "✓ $sha: $message"
            fi
          done
          echo ""
          echo "✅ All commits follow Conventional Commits format"

  schema-check:
    name: Validate schemas are up-to-date
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Download latest schemas
        run: python scripts/sync_schemas.py

      - name: Fix schema references
        run: python scripts/fix_schema_refs.py

      - name: Generate models
        run: python scripts/generate_types.py

      - name: Validate generated code syntax
        run: |
          echo "Validating generated code can be parsed..."
          python -m py_compile src/adcp/types/_generated.py
          echo "✓ Syntax validation passed"

      - name: Validate generated code imports
        run: |
          echo "Validating generated code can be imported..."
          python -c "from adcp.types import _generated as generated; print(f'✓ Successfully imported {len(dir(generated))} symbols')"

      - name: Run code generation tests
        run: |
          echo "Running code generation test suite..."
          pytest tests/test_code_generation.py -v --tb=short

      - name: Check for schema drift
        run: |
          if git diff --exit-code src/adcp/types/generated.py schemas/cache/; then
            echo "✓ Schemas are up-to-date"
          else
            echo "✗ Schemas are out of date!"
            echo "Run: make regenerate-schemas"
            git diff src/adcp/types/generated.py
            exit 1
          fi
